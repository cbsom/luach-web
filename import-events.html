<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Import Old Events to IndexedDB</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      #log {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 6px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
      }
      .log-success {
        color: #4caf50;
      }
      .log-error {
        color: #f44336;
      }
      .log-info {
        color: #2196f3;
      }
      .log-warning {
        color: #ff9800;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
      }
      .stat-box {
        padding: 15px;
        background: #f0f0f0;
        border-radius: 6px;
        text-align: center;
      }
      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #4caf50;
      }
      .stat-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìÖ Import Old Events</h1>
      <p class="subtitle">This tool will import events from oldEvents.xml into IndexedDB</p>

      <div class="stats">
        <div class="stat-box">
          <div class="stat-number" id="totalEvents">0</div>
          <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="importedEvents">0</div>
          <div class="stat-label">Imported</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="errorCount">0</div>
          <div class="stat-label">Errors</div>
        </div>
      </div>

      <div>
        <input type="file" id="fileInput" accept=".xml" style="margin-bottom: 15px" />
        <br />
        <button id="importBtn" onclick="importEvents()">Import Events</button>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="viewDatabase()">View Database</button>
      </div>

      <div id="log"></div>
    </div>

    <script type="module">
      // Import the database functions
      import { initDB, saveAllEvents, getAllEvents } from "./src/db.js";
      import { jDate } from "jcal-zmanim";

      let parsedEvents = [];

      // Make functions available globally
      window.importEvents = async function () {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          log("Please select an XML file first", "error");
          return;
        }

        log("Starting import process...", "info");

        try {
          // Read the file
          const text = await file.text();
          log("File loaded successfully", "success");

          // Parse XML
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, "text/xml");

          // Check for parsing errors
          const parserError = xmlDoc.querySelector("parsererror");
          if (parserError) {
            throw new Error("XML parsing failed: " + parserError.textContent);
          }

          // Get all UserOccasion elements
          const occasions = xmlDoc.querySelectorAll("UserOccasion");
          log(`Found ${occasions.length} events in XML`, "info");
          document.getElementById("totalEvents").textContent = occasions.length;

          // Convert to our format
          const events = [];
          let errorCount = 0;

          for (let i = 0; i < occasions.length; i++) {
            try {
              const occasion = occasions[i];
              const event = convertOccasionToEvent(occasion, i);
              events.push(event);
            } catch (error) {
              errorCount++;
              log(`Error converting event ${i + 1}: ${error.message}`, "error");
              document.getElementById("errorCount").textContent = errorCount;
            }
          }

          log(`Successfully converted ${events.length} events`, "success");

          // Initialize database
          await initDB();
          log("Database initialized", "success");

          // Get existing events
          const existingEvents = await getAllEvents();
          log(`Found ${existingEvents.length} existing events in database`, "info");

          // Merge with existing events (avoid duplicates by name and date)
          const mergedEvents = [...existingEvents];
          let addedCount = 0;

          for (const newEvent of events) {
            const isDuplicate = existingEvents.some(
              (existing) =>
                existing.name === newEvent.name &&
                existing.jYear === newEvent.jYear &&
                existing.jMonth === newEvent.jMonth &&
                existing.jDay === newEvent.jDay
            );

            if (!isDuplicate) {
              mergedEvents.push(newEvent);
              addedCount++;
            }
          }

          log(
            `Adding ${addedCount} new events (${events.length - addedCount} duplicates skipped)`,
            "info"
          );

          // Save to database
          await saveAllEvents(mergedEvents);
          log(`‚úÖ Successfully imported ${addedCount} events!`, "success");
          document.getElementById("importedEvents").textContent = addedCount;

          log("Import complete! You can now close this page and refresh your app.", "success");
        } catch (error) {
          log(`‚ùå Import failed: ${error.message}`, "error");
          console.error(error);
        }
      };

      function convertOccasionToEvent(occasion, index) {
        // Extract data from XML
        const name = getTextContent(occasion, "Name");
        const notes = getTextContent(occasion, "Notes");
        const occasionType = getTextContent(occasion, "UserOccasionType");
        const gregDate = getTextContent(occasion, "JewishDate GregorianDate");
        const absDate = parseInt(getTextContent(occasion, "JewishDate AbsoluteDate"));

        // Get colors
        let backColor = getColorAttribute(occasion, "BackColor");
        let textColor = getColorAttribute(occasion, "Color");

        // Convert color names to hex
        backColor = convertColorToHex(backColor);
        textColor = convertColorToHex(textColor);

        // Create jDate from absolute date or Gregorian date
        let jd;
        if (absDate && !isNaN(absDate)) {
          jd = new jDate(absDate);
        } else if (gregDate) {
          jd = new jDate(new Date(gregDate));
        } else {
          throw new Error("No valid date found");
        }

        // Map occasion type to our event type
        const typeMap = {
          HebrewDateRecurringYearly: 1, // UserEventTypes.HebrewDateRecurringYearly
          HebrewDateRecurringMonthly: 2,
          SecularDateRecurringYearly: 3,
          SecularDateRecurringMonthly: 4,
          OneTime: 5,
        };

        const type = typeMap[occasionType] || 1;

        // Get reminder setting
        const sendReminders = getTextContent(occasion, "SendEmailReminders") === "true";

        // Create the event object
        return {
          id: `imported-${Date.now()}-${index}`,
          name: name || "Untitled Event",
          notes: notes || "",
          type: type,
          jYear: jd.Year,
          jMonth: jd.Month,
          jDay: jd.Day,
          sDate: jd.getDate().toISOString(),
          backColor: backColor,
          textColor: textColor,
          remindDayOf: sendReminders,
          remindDayBefore: false,
        };
      }

      function getTextContent(element, path) {
        const parts = path.split(" ");
        let current = element;

        for (const part of parts) {
          const child = current.querySelector(part);
          if (!child) return "";
          current = child;
        }

        return current.textContent.trim();
      }

      function getColorAttribute(element, tagName) {
        const colorElement = element.querySelector(tagName);
        if (!colorElement) return "#fde047"; // Default yellow

        const colorHtml = colorElement.getAttribute("ColorHtml");
        return colorHtml || "#fde047";
      }

      function convertColorToHex(color) {
        if (!color || color === "") return "#fde047";
        if (color.startsWith("#")) return color;

        // Color name to hex mapping
        const colorMap = {
          Yellow: "#FFFF00",
          Blue: "#0000FF",
          Lime: "#00FF00",
          Black: "#000000",
          White: "#FFFFFF",
          Maroon: "#800000",
          Navy: "#000080",
          Green: "#008000",
          Red: "#FF0000",
          Purple: "#800080",
          Orange: "#FFA500",
        };

        return colorMap[color] || color;
      }

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      window.clearLog = function () {
        document.getElementById("log").innerHTML = "";
        document.getElementById("totalEvents").textContent = "0";
        document.getElementById("importedEvents").textContent = "0";
        document.getElementById("errorCount").textContent = "0";
      };

      window.viewDatabase = async function () {
        try {
          await initDB();
          const events = await getAllEvents();
          log(`Database contains ${events.length} events`, "info");
          console.log("All events:", events);
          log("Check browser console for full event list", "info");
        } catch (error) {
          log(`Error viewing database: ${error.message}`, "error");
        }
      };

      // Initialize
      log("Import tool ready. Select oldEvents.xml and click Import.", "info");
    </script>
  </body>
</html>
